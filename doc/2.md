# VCO→VCA 音響出力問題のデバッグ記録（最終版）

## 1. 問題の概要

VCOモジュールの出力をVCAモジュールの音声入力に接続した際、VCAから音が出力されない。

## 2. デバッグの経緯と教訓

この問題のデバッグは、当初の想定よりもはるかに複雑な道のりとなった。単純な接続の問題かと思われたが、実際には複数の要因が絡み合っていた。以下にその経緯を記録する。

### 第1段階：初期調査と誤った仮説

- `minimal_test.py`など、単純な環境では問題が再現しないことから、クラスの複雑な実装に起因する副作用（Heisenbug）が疑われた。
- `pyo`オブジェクトがガベージコレクション(GC)される問題は、`pyo`開発における典型的な落とし穴であり、当初の調査ではこれが原因と強く疑われた。実際に`pyo_objects`リストへの参照追加が漏れていたため、これを修正した。しかし、これだけでは問題は解決しなかった。

### 第2段階：漸進的テストによる絞り込み

- 動作する最小構成のテストファイルに対し、実際のモジュールの機能を一つずつ移植していく「漸進的テスト」を実施。
- 驚くべきことに、`VCO`と`VCA`の核心的な機能をほぼ完全に再現しても、テストファイル上では**問題は再現しなかった**。
- この結果は、問題が特定の機能ではなく、**テスト環境と実際の実行環境の「状態の差異」**に起因することを示唆した。

### 第3段階：デバッグログによる真の原因特定

- `connection_debug_test.py`という、より実際の使われ方に近いテスト環境でデバッグログを仕込んだ結果、ついに真の原因が判明した。
- VCAのゲインを計算する`_calculate_gain`メソッドの出力が、常に`0.0`になっていたことが直接の原因だった。

## 3. 真の根本原因

音が出なかった直接の原因は、`VCA`モジュールの`_calculate_gain`メソッド内に存在した、2つの類似したロジックバグであった。

1.  **`gate_input`のデフォルト値の問題**: `gate_input`が未接続の場合、デフォルト値`0`が使用され、ゲイン乗数が`0.0`となり、最終的なゲインがゼロになっていた。
2.  **`velocity_cv`のデフォルト値の問題**: 同様に、`velocity_cv`が未接続の場合もデフォルト値`0`が使用され、ゲインがゼロになっていた。

シンセサイザーの一般的な動作として、これらの入力が未接続の場合は、ゲートが開き、ベロシティが最大（つまり乗数が`1.0`）として扱われるべきだった。

## 4. 最終的な修正内容

根本原因を解決するため、以下の修正を行った。

1.  **`VCA`クラスの修正**: `__init__`メソッドにおいて、`gate_input`と`velocity_cv`のデフォルト値を、それぞれ`1.0`に設定した。これにより、入力が未接続の場合でもゲインが正しく計算されるようになった。

    ```python
    # src/modules/vca.py の __init__ 内
    self.add_input("gate_input", 1.0)  # デフォルトでゲートを開く
    self.add_input("velocity_cv", 1.0) # デフォルトでベロシティ最大
    ```

2.  **潜在的バグの修正**: 直接の原因ではなかったものの、調査過程で発見された「`pyo`オブジェクトのガベージコレクション問題」も併せて修正した。これにより、将来的に予期せぬ問題が発生するリスクを低減させた。

3.  **全体的なリファクタリング**: デバッグ完了後、`vco.py`と`vca.py`のコード全体をリファクタリングし、可読性と保守性を向上させた。また、`src/modules`ディレクトリに概要を説明する`README.md`を追加した。

## 5. 総括

今回のデバッグは、「動くはずのコードが動かない」という典型的なHeisenbugの様相を呈していた。最小構成のテストでは問題が再現せず、原因の特定は困難を極めた。しかし、最終的には、デバッグログを仕込んだ適切なテスト環境で内部状態を観察するという、地道だが確実なアプローチによって原因を特定できた。複雑な副作用を疑う前に、まずは基本的なデータの流れと初期値の正しさを疑うべき、という重要な教訓が得られた。